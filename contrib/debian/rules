#!/usr/bin/make -f

# Find the arch we are building for, as this determines
# the location of plugins in /usr/lib
DEB_HOST_MULTIARCH ?= $(shell dpkg-architecture -qDEB_HOST_MULTIARCH)
TOP = $(CURDIR)/debian/hibenchmarks

%:
	# For jessie and beyond
	#
	dh $@ --with autoreconf,systemd

	# For wheezy or other non-systemd distributions use the following. You
	# should also see contrib/README.md which gives details of updates to
	# make to debian/control.
	#
	#dh $@ --with autoreconf

override_dh_auto_configure:
	dh_auto_configure -- --with-math --with-webdir=/var/lib/hibenchmarks/www

debian/%.postinst: debian/%.postinst.in
	sed 's/@DEB_HOST_MULTIARCH@/$(DEB_HOST_MULTIARCH)/g' $< > $@

override_dh_install: debian/hibenchmarks.postinst
	dh_install

	# Remove unneeded .keep files
	#
	find "$(TOP)" -name .keep -exec rm '{}' ';'

	# Move files that local user shouldn't be editing to /usr/share/hibenchmarks
	#
	mkdir -p "$(TOP)/usr/share/hibenchmarks"
	for D in $$(find "$(TOP)/var/lib/hibenchmarks/www/" -maxdepth 1 -type d -printf '%f '); do \
		echo Relocating $$D; \
		mv "$(TOP)/var/lib/hibenchmarks/www/$$D" "$(TOP)/usr/share/hibenchmarks/$$D"; \
		ln -s "/usr/share/hibenchmarks/$$D" "$(TOP)/var/lib/hibenchmarks/www/$$D"; \
	done

	# Update postinst to set correct group for www files on installation.
	# Should probably be dpkg-statoverride really, but that gets *really*
	# messy. We also set all web files in /var as conffiles so an upgrade
	# doesn't splat them.
	#
	for D in $$(find "$(TOP)/var/lib/hibenchmarks/www/" -maxdepth 1 -type f -printf '%f '); do \
		echo Updating postinst for $$D; \
		sed -i "s/^#PERMS#/chgrp hibenchmarks \/var\/lib\/hibenchmarks\/www\/$$D\n#PERMS#/g" \
			$(CURDIR)/debian/hibenchmarks.postinst; \
		echo "/var/lib/hibenchmarks/www/$$D" >> $(CURDIR)/debian/hibenchmarks.conffiles; \
	done
	sed -i "/^#PERMS#/d" $(CURDIR)/debian/hibenchmarks.postinst

override_dh_installdocs:
	dh_installdocs

	# Docs should not be under /usr/lib
	#
	mv $(TOP)/usr/lib/$(DEB_HOST_MULTIARCH)/hibenchmarks/plugins.d/README.md \
		$(TOP)/usr/share/doc/hibenchmarks/README.plugins.md
	mv $(TOP)/usr/lib/$(DEB_HOST_MULTIARCH)/hibenchmarks/charts.d/README.md \
		$(TOP)/usr/share/doc/hibenchmarks/README.charts.md

	# This doc is currently empty, so no point installing it.
	#
	rm $(TOP)/usr/lib/$(DEB_HOST_MULTIARCH)/hibenchmarks/node.d/README.md

override_dh_fixperms:
	dh_fixperms

	# apps.plugin should only be runnable by the hibenchmarks user. It will be
	# given extra capabilities in the postinst script.
	#
	chmod 0754 $(TOP)/usr/lib/$(DEB_HOST_MULTIARCH)/hibenchmarks/plugins.d/apps.plugin

override_dh_installlogrotate:
	cp system/hibenchmarks.logrotate debian/hibenchmarks.logrotate
	dh_installlogrotate

override_dh_clean:
	dh_clean

	# Tidy up copied/generated files
	#
	-[ -r $(CURDIR)/debian/hibenchmarks.logrotate ] && rm $(CURDIR)/debian/hibenchmarks.logrotate
	-[ -r $(CURDIR)/debian/hibenchmarks.postinst ] && rm $(CURDIR)/debian/hibenchmarks.postinst
	-[ -r $(CURDIR)/debian/hibenchmarks.conffiles ] && rm $(CURDIR)/debian/hibenchmarks.conffiles
